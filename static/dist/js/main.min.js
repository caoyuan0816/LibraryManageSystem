function getUrlParam(e){var o=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(o);return null!==a?unescape(a[2]):null}function getUrlParam(e){var o=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(o);return null!=a?unescape(a[2]):null}function bookSearchAjax(e){$.post("/api/book-search/",e,function(e){if(e.status){$(".book-dis").empty();for(var o=0;o<e.book_list.length;o++){var a='<li><a href="/book-detail/?bookid='+e.book_list[o].id+'"><img src="'+e.book_list[o].photoURL+'" alt=""/><p>'+e.book_list[o].bookName+"</p></a></li>";$(".book-dis").append(a)}var r=8,s=e.all_number,n=s/r;s%r!=0&&n++,$(".pagination").empty();for(var o=1;n>=o;o++){var t="<li><span>"+o+"</span></li>";$(".pagination").append(t)}}else alertFun("not found book!"),setTimeout(function(){$("#alertModal").modal("hide")},1200)})}function freshBookList(e){var o={};o.page=e,o.classify="";var a=localStorage.getItem("globalSearchData"),r=JSON.parse(a);console.log(a),o.type=r.searchType,o.value=r.searchValue,bookSearchAjax(o)}function loginCheck(){return $("#loginForm").validate({rules:{username:{required:!0},password:{required:!0}},messages:{username:{required:"Username couldn't be null"},password:{required:"Password couldn't be null"}}})}function registCheck(){return $("#registForm").validate({rules:{schoolId:{required:!0,maxlength:10,minlength:10},registUsername:{required:!0},email:{required:!0,email:!0},registPassword:{required:!0,minlength:6,maxlength:20},conPassword:{required:!0,minlength:6,maxlength:20,equalTo:"#registPassword"}},messages:{schoolId:{required:"StudentID couldn't be null",maxlength:"The length of StudentID is 10",minlength:"The length of StudentID is 10"},registUsername:{required:"Nickname couldn't be null"},email:{required:"Email couldn't be null",email:"The format of email is incorrect"},registPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},conPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20",equalTo:"Please input the same password twice"}}})}function modifyPassCheck(){return $("#modifyForm").validate({rules:{oldPassword:{required:!0,minlength:6,maxlength:20},newPassword:{required:!0,minlength:6,maxlength:20},conNewPassword:{required:!0,minlength:6,maxlength:20,equalTo:"#newPassword"}},messages:{oldPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},newPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},conNewPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20",equalTo:"Please input the same password twice"}}})}function saveUserInf(){if($("#rmbUser").get(0).checked){var e=$("#username").val(),o=$("#password").val();$.cookie("rmbUserFlag","true",{expires:7}),$.cookie("username",e,{expires:7}),$.cookie("password",o,{expires:7})}else $.cookie("rmbUserFlag","false",{expires:-1}),$.cookie("username","",{expires:-1}),$.cookie("password","",{expires:-1});console.log($.cookie("username")),console.log($.cookie("password"))}function alertFun(e){$("#alertMsg").text(e),$("#alertModal").on("show.bs.modal",function(){console.log("alertModal");var e=$(this),o=e.find(".modal-dialog"),a=($(window).height()-o.height())/2;o.css({margin:a+"px auto"})}),$("#alertModal").modal("show")}function alertWithClose(e){alertFun(e),setTimeout(function(){$("#alertModal").modal("hide")},1500)}function OnclickLogout(){$.post("/api/logout",function(e){var o="'",a=new RegExp(o,"g");e=e.replace(a,'"'),console.log(JSON.parse(e));var r=JSON.parse(e);"true"==r.status?(alertFun("Logout Success!"),setTimeout("javascript:location.reload()",1500)):(alertFun("Logout defeat!"),setTimeout("javascript:location.reload()",1500))})}function abc(){var e={};e.username="123",e.password="123",$.post("/api/login",e,function(e){console.log(e)})}function freshCurrentRecords(){var e={};e.username=getUrlParam("username"),$.post("/api/current-records/",e,function(e){if(e.status)for(var o=$("#currentRecords"),a=0;a<e.records.length;a++){var r="<tr><td>"+e.records[a].bookid+"</td><td>"+e.records[a].bookName+"</td><td>"+e.records[a].author+"</td><td>"+e.records[a].borrowtime+"</td><td>"+e.records[a].actualreturntime+"</td></tr>";o.append(r)}else alertWithClose("load error");console.log(e)})}function freshHistoryRecords(){var e={};e.username=getUrlParam("username"),$.post("/api/history-records/",e,function(e){if(e.status){var o=$("#historyRecords");console.log(e);for(var a=0;a<e.records.length;a++){var r="<tr><td>"+e.records[a].bookid+"</td><td>"+e.records[a].bookName+"</td><td>"+e.records[a].author+"</td><td>"+e.records[a].borrowtime+"</td><td>"+e.records[a].actualreturntime+"</td></tr>";o.append(r)}}else alertWithClose("load error")})}function freshUserInformationPage(){var e={};e.username=getUrlParam("username"),$.post("/api/user/",e,function(e){$(".read-intr .borrowed span").text(e.borrowed),$(".read-intr .overdue span").text(e.overdue),$(".read-intr .accumlated span").text(e.accumulated)})}$(function(){var e=getUrlParam("bookid");$.post("/api/book-detail/",{bookid:e},function(e){if(e.status){$(".book-content").empty();var o='<div class="row"><div class="col-sm-6 book-pho"><a href="'+e.book.photoURL+'"><img src="'+e.book.photoURL+'" alt=""/></a></div><div class="col-sm-6 book-inf"><p><span>书名：</span><span>'+e.book.bookName+"</span></p><p><span>作者：</span><span>"+e.book.author+"</span></p><p><span>出版社：</span><span>"+e.book.publisher+"</span></p><p><span>出版时间：</span><span>"+e.book.publishTime+"</span></p><p><span>ＩＳＢＮ码：</span><span>"+e.book.isbn+"</span></p><p><span>译者：</span><span>"+e.book.translator+"</span></p><p><span>现存量：</span><span>"+e.book.currentStorage+"</span></p><p>作者介绍：</p><p>"+e.book.authorIntroduction+'</p></div></div><div class="row book-intr"><h4>内容简介：</h4><pre>'+e.book.bookIntroduction+"</pre></div>";$(".book-content").append(o)}})});var globalParas={};$(function(){var e=window.location.href;-1!=e.indexOf("book-search")&&freshBookList(1),$(".pagination").on("click","span",function(e){e.preventDefault();var o=parseInt($(this).text());paras={},globalParas.page=o,bookSearchAjax(globalParas)}),$("#categoryList").on("click","a",function(e){e.preventDefault(),globalParas.type="",globalParas.value="";var o={};o.classify=$(this).data("class"),o.page=1,globalParas.classify=o.classify,bookSearchAjax(o)}),$("#searchBtn").on("click",function(e){e.preventDefault();var o=window.location.href;if(o.indexOf("book-search"),console.log(o.indexOf("book-search")),-1!=o.indexOf("book-search")){console.log("ajax"),globalParas.classify="";var a={};a.page=1,a.type=$("#searchType").val(),a.value=$("#searchValue")[0].value,globalParas.type=a.type,globalParas.value=a.value,bookSearchAjax(a)}else{console.log("reload");var r={};r.searchType=$("#searchType").val(),r.searchValue=$("#searchValue")[0].value;var s=JSON.stringify(r);localStorage.setItem("globalSearchData",s),window.location.href="/book-search/"}}),$("#searchForm .form-group").keydown(function(e){13==e.keyCode&&$("#searchBtn").click()})}),$(function(){"true"==$.cookie("rmbUserFlag")&&($("#rmbUser").attr("checked",!0),$("#username").val($.cookie("username")),$("#password").val($.cookie("password"))),$("#rmbUser").get(0).checked||($.cookie("rmbUserFlag","false",{expires:-1}),$.cookie("username","",{expires:-1}),$.cookie("password","",{expires:-1})),$("#login").on("click",function(e){if(e.preventDefault(),saveUserInf(),loginCheck().form()){var o={};o.username=$("#username")[0].value,o.password=$("#password")[0].value,$.post("/api/login",o,function(e){var o="'",a=new RegExp(o,"g");e=e.replace(a,'"'),console.log(JSON.parse(e));var r=JSON.parse(e);"true"==r.status?($("#loginModal").modal("hide"),alertFun("Login Success!"),setTimeout("javascript:location.reload()",1500)):($(".login-error").css({display:"block"}),$(".login-error").text(r.message))})}}),$("#loginForm").keydown(function(e){console.log("keydown"),13==e.keyCode&&$("#login").click()}),$("#regist").on("click",function(e){if(e.preventDefault(),registCheck().form()){var o={};o.email=$("#email")[0].value,o.username=$("#registUsername")[0].value,o.password=$("#conPassword")[0].value,console.log(o),$.post("/api/register/",o,function(e){console.log(e),e.status?($("#registModal").modal("hide"),alertWithClose("Regist Success!")):($(".regist-error").css({display:"block"}),$(".regist-error").text(e.message))})}}),$("#registForm").keydown(function(e){13==e.keyCode&&$("#regist").click()}),$("#modify").on("click",function(){if(modifyPassCheck().form()){var e={};e.password=$("#oldPassword")[0].value,e.newpassword=$("#newPassword")[0].value,e.username=__username,console.log(e),$.post("/api/reset-password/",e,function(e){e.status?($("#modifyModal").modal("hide"),alertWithClose("Modify password successfully!")):($(".modify-error").css({display:"block"}),$(".modify-error").text(e.message))})}}),$("#forgetBtn").on("click",function(e){$("#forgetBtn").attr("disabled","disabled");var o={};o.email=$("#email-input")[0].value,console.log(o),$.post("/api/forget-password/",o,function(e){e.status?(alertFun("Sent success! Please check your email:)"),setTimeout(function(){$("#alertModal").modal("hide"),window.location.href="http://test.yuan25.com"},1200)):($(".forget-inf").css({display:"block"}),$(".forget-inf").text(e.message))})}),$("#book-upload-button").on("click",function(e){var o={};o.bookname=$("#bookName").val(),o.author=$("#author").val(),o.publisher=$("#publisher").val(),o.publishtime=$("#publishTime").val(),o.isbn=$("#ISBN").val(),o.translator=$("#translator").val(),o.photoURL=$("#photoUrl").val(),o.authorintro=$("#authorIntroduction").val(),o.bookintro=$("#bookIntroduction").val(),$.post("/api/book-upload/",o,function(e){e.status?(alertFun(e.message),setTimeout(function(){$("#alertModal").modal("hide"),location.reload()},1200)):alertWithClose(e.message)})})}),$("document").ready(function(){}),$(function(){$("#borrowForm #borrowBtn").on("click",function(e){e.preventDefault();var o={};o.username=$("#borrowUsername")[0].value,o["book-id"]=$("#isbn")[0].value,console.log(o),$.post("/api/borrow-book/",o,function(e){alertWithClose(e.message)})}),$("#borrowForm").keydown(function(e){13==e.keyCode&&$("#borrowForm #borrowBtn").click()}),$("#returnForm #returnBtn").on("click",function(e){e.preventDefault();var o={};o.username=$("#returnUsername")[0].value,o["book-id"]=$("#isbn")[0].value,console.log(o),$.post("/api/borrow-book/",o,function(e){console.log(e),alertWithClose(e.message)})}),$("#returnForm").keydown(function(e){13==e.keyCode&&$("#returnForm #returnBtn").click()})}),$(function(){var e=window.location.href;-1!=e.indexOf("current-records")&&freshCurrentRecords(),-1!=e.indexOf("history-records")&&freshHistoryRecords(),-1!=e.indexOf("user?")&&freshUserInformationPage()});