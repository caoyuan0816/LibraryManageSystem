function getBookList(){var e={};e.page=1,e.classify="",e.type="",e.value="",e.all="true",$.post("/api/book-search/",e,function(e){if(e.status){for(var o=$("#manageBook"),a=0;a<e.book_list.length;a++){var r='<tr><td><img class="bookBarcode" id="'+e.book_list[a].id+'" style="width:400px;" /></td><td class="bookid">'+e.book_list[a].id+"</td><td>"+e.book_list[a].bookName+"</td><td>"+e.book_list[a].author+'</td><td><a data-toggle="modal" data-target=".modify-modal" class="modifyBook">modify</a><span> | </span><a class="deleteBook">delete</a></td></tr>';o.append(r)}getBookBarcode()}})}function getBookBarcode(){var e=$(".bookBarcode");console.log(e);for(var o=0;o<e.length;o++){$imgElem=e[o];var a=e[o].id;console.log(typeof $("#"+a).JsBarcode),JsBarcode($imgElem,a,{format:"CODE128",displayValue:!0,fontSize:20})}}function getUrlParam(e){var o=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(o);return null!==a?unescape(a[2]):null}function getUrlParam(e){var o=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(o);return null!=a?unescape(a[2]):null}function bookSearchAjax(e){$.post("/api/book-search/",e,function(e){if(console.log(e),e.status){$(".book-dis").empty();for(var o=0;o<e.book_list.length;o++){var a='<li><a href="/book-detail/?bookid='+e.book_list[o].id+'"><img src="'+e.book_list[o].photoURL+'" alt=""/><p>'+e.book_list[o].bookName+"</p></a></li>";$(".book-dis").append(a)}var r=8,t=e.all_number,s=t/r;t%r!=0&&s++,$(".pagination").empty();for(var o=1;s>=o;o++){var n="<li><span>"+o+"</span></li>";$(".pagination").append(n)}}else alertFun("not found book!"),setTimeout(function(){$("#alertModal").modal("hide")},1200)})}function freshBookList(e){var o={};o.page=e;var a=localStorage.getItem("globalSearchData"),r=JSON.parse(a);console.log(a),o.type=r.searchType,o.value=r.searchValue,o.classify=r.classify,bookSearchAjax(o)}function loginCheck(){return $("#loginForm").validate({rules:{username:{required:!0},password:{required:!0}},messages:{username:{required:"Username couldn't be null"},password:{required:"Password couldn't be null"}}})}function registCheck(){return $("#registForm").validate({rules:{schoolId:{required:!0,maxlength:10,minlength:10},registUsername:{required:!0},email:{required:!0,email:!0},registPassword:{required:!0,minlength:6,maxlength:20},conPassword:{required:!0,minlength:6,maxlength:20,equalTo:"#registPassword"}},messages:{schoolId:{required:"StudentID couldn't be null",maxlength:"The length of StudentID is 10",minlength:"The length of StudentID is 10"},registUsername:{required:"Nickname couldn't be null"},email:{required:"Email couldn't be null",email:"The format of email is incorrect"},registPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},conPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20",equalTo:"Please input the same password twice"}}})}function modifyPassCheck(){return $("#modifyForm").validate({rules:{oldPassword:{required:!0,minlength:6,maxlength:20},newPassword:{required:!0,minlength:6,maxlength:20},conNewPassword:{required:!0,minlength:6,maxlength:20,equalTo:"#newPassword"}},messages:{oldPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},newPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20"},conNewPassword:{required:"Password couldn't be null",minlength:"The minimum length of password is 6",maxlength:"The maximum length of password is 20",equalTo:"Please input the same password twice"}}})}function saveUserInf(){if($("#rmbUser").get(0).checked){var e=$("#username").val(),o=$("#password").val();$.cookie("rmbUserFlag","true",{expires:7}),$.cookie("username",e,{expires:7}),$.cookie("password",o,{expires:7})}else $.cookie("rmbUserFlag","false",{expires:-1}),$.cookie("username","",{expires:-1}),$.cookie("password","",{expires:-1});console.log($.cookie("username")),console.log($.cookie("password"))}function alertFun(e){$("#alertMsg").text(e),$("#alertModal").on("show.bs.modal",function(){console.log("alertModal");var e=$(this),o=e.find(".modal-dialog"),a=($(window).height()-o.height())/2;o.css({margin:a+"px auto"})}),$("#alertModal").modal("show")}function alertWithClose(e){alertFun(e),setTimeout(function(){$("#alertModal").modal("hide")},1500)}function OnclickLogout(){$.post("/api/logout",function(e){var o="'",a=new RegExp(o,"g");e=e.replace(a,'"'),console.log(JSON.parse(e));var r=JSON.parse(e);"true"==r.status?(alertFun("Logout Success!"),setTimeout("javascript:location.href='../'",1500)):(alertFun("Logout defeat!"),setTimeout("javascript:location.reload()",1500))})}function abc(){var e={};e.username="123",e.password="123",$.post("/api/login",e,function(e){console.log(e)})}function freshCurrentRecords(){var e={};e.username=getUrlParam("username"),$.post("/api/current-records/",e,function(e){if(console.log(e),e.status)for(var o=$("#currentRecords"),a=0;a<e.records.length;a++){var r=new Date(e.records[a].borrowdate),t=new Date(e.records[a].returndate);console.log(r);var s="<tr><td>"+e.records[a].bookid+"</td><td>"+e.records[a].bookname+"</td><td>"+e.records[a].author+"</td><td>"+r.Format("yyyy-MM-dd hh:mm:ss")+"</td><td>"+t.Format("yyyy-MM-dd hh:mm:ss")+"</td></tr>";o.append(s)}else alertWithClose("load error");console.log(e)})}function freshHistoryRecords(){var e={};e.username=getUrlParam("username"),$.post("/api/history-records/",e,function(e){if(e.status)for(var o=$("#historyRecords"),a=0;a<e.records.length;a++){var r=new Date(e.records[a].borrowdate),t=new Date(e.records[a].returndate),s="";s=-1==e.records[a].actualreturndate?"--":new Date(e.records[a].actualreturndate).Format("yyyy-MM-dd hh:mm:ss");var n="<tr><td>"+e.records[a].bookid+"</td><td>"+e.records[a].bookname+"</td><td>"+e.records[a].author+"</td><td>"+r.Format("yyyy-MM-dd hh:mm:ss")+"</td><td>"+t.Format("yyyy-MM-dd hh:mm:ss")+"</td><td>"+s+"</td></tr>";o.append(n)}else alertWithClose("load error")})}function freshUserInformationPage(){var e={};e.username=getUrlParam("username"),$.post("/api/user/",e,function(e){console.log(e),$(".read-intr .borrowed span").text(e.borrowed),$(".read-intr .overdue span").text(e.overdue),$(".read-intr .accumlated span").text(e.accumulated)})}function feshUserFine(){var e={};e.username=getUrlParam("username"),$.post("/api/user-fine/",e,function(e){if(e.status){var o=$("#userFine");console.log(e);for(var a=0;a<e.records.length;a++){var r=new Date(e.records[a].borrowdate),t=new Date(e.records[a].returndate),s="";s=-1==e.records[a].actualreturndate?"--":new Date(e.records[a].actualreturndate).Format("yyyy-MM-dd hh:mm:ss");var n="<tr><td>"+e.records[a].bookid+"</td><td>"+e.records[a].bookname+"</td><td>"+r.Format("yyyy-MM-dd hh:mm:ss")+"</td><td>"+t.Format("yyyy-MM-dd hh:mm:ss")+"</td><td>"+s+"</td><td>"+e.fines[a]+"</td></tr>";o.append(n)}}else alertWithClose("load error")})}$(function(){getBookList(),$("#manageBook").on("click","a",function(e){e.preventDefault();var o=$(this),a={};if(a["book-id"]=$(this).parent().siblings(".bookid").text(),"modifyBook"==$(this).attr("class")){var r={};r.bookname=$("#bookName").val(),r.author=$("#author").val(),r.publisher=$("#publisher").val(),r.publishtime=$("#publishTime").val(),r.isbn=$("#ISBN").val(),r.translator=$("#translator").val(),r.photoURL=$("#photoUrl").val(),r.authorintro=$("#authorIntroduction").val(),r.bookintro=$("#bookIntroduction").val(),$("#modifyBookBtn").on("click",function(e){e.preventDefault(),$.post("/api/modify-book/",r,function(e){e.status?(alertFun(e.message),setTimeout(function(){$("#alertModal").modal("hide"),location.reload()},1200)):alertWithClose(e.message)})})}else{var t=confirm("Do you really want to delete the book?");1==t&&$.post("/api/delete-book/",a,function(e){e.status?(o.parent().parent().hide("400"),alertWithClose("delete successfully")):alertWithClose("delete fail")})}})}),$(function(){var e=getUrlParam("bookid");$.post("/api/book-detail/",{bookid:e},function(e){if(e.status){$(".book-content").empty();var o="";o=e.book.borrowed?'<button type="button" class="btn btn-danger" style="margin-left: 30px;" disabled>can not  borrow</button>':'<button type="button" class="btn btn-success" style="margin-left: 30px;" disabled>can borrow</button>';var a='<div class="row"><div class="col-sm-6 book-pho"><a href="'+e.book.photoURL+'"><img src="'+e.book.photoURL+'" alt=""/></a></div><div class="col-sm-6 book-inf"><p style="font-size: 22px;"><span>书名：</span><span>'+e.book.bookName+"</span>"+o+"</p><p><span>作者：</span><span>"+e.book.author+"</span></p><p><span>出版社：</span><span>"+e.book.publisher+"</span></p><p><span>出版时间：</span><span>"+e.book.publishTime+"</span></p><p><span>ＩＳＢＮ码：</span><span>"+e.book.isbn+"</span></p><p><span>译者：</span><span>"+e.book.translator+"</span></p><p>作者介绍：</p><p>"+e.book.authorIntroduction+'</p></div></div><div class="row book-intr"><h4>内容简介：</h4><pre>'+e.book.bookIntroduction+"</pre></div>";$(".book-content").append(a)}})});var globalParas={};$(function(){var e=window.location.href;-1!=e.indexOf("book-search")&&freshBookList(1),$(".pagination").on("click","span",function(e){e.preventDefault();var o=parseInt($(this).text());paras={},globalParas.page=o,bookSearchAjax(globalParas)}),$("#categoryList").on("click","a",function(o){o.preventDefault(),globalParas.type="",globalParas.value="";var a={};if(a.classify=$(this).data("class"),a.page=1,globalParas.classify=a.classify,-1!=e.indexOf("book-search"))bookSearchAjax(a);else{var r={};r.classify=a.classify,r.searchType="",r.searchValue="";var t=JSON.stringify(r);localStorage.setItem("globalSearchData",t),window.location.href="/book-search/"}}),$("#searchBtn").on("click",function(e){e.preventDefault();var o=window.location.href;if(o.indexOf("book-search"),console.log(o.indexOf("book-search")),-1!=o.indexOf("book-search")){console.log("ajax"),globalParas.classify="";var a={};a.page=1,a.type=$("#searchType").val(),a.value=$("#searchValue")[0].value,globalParas.type=a.type,globalParas.value=a.value,bookSearchAjax(a)}else{console.log("reload");var r={};r.searchType=$("#searchType").val(),r.searchValue=$("#searchValue")[0].value;var t=JSON.stringify(r);localStorage.setItem("globalSearchData",t),window.location.href="/book-search/"}}),$("#searchForm .form-group").keydown(function(e){13==e.keyCode&&$("#searchBtn").click()})}),$(function(){"true"==$.cookie("rmbUserFlag")&&($("#rmbUser").attr("checked",!0),$("#username").val($.cookie("username")),$("#password").val($.cookie("password"))),$("#rmbUser").get(0).checked||($.cookie("rmbUserFlag","false",{expires:-1}),$.cookie("username","",{expires:-1}),$.cookie("password","",{expires:-1})),$("#login").on("click",function(e){if(e.preventDefault(),saveUserInf(),loginCheck().form()){var o={};o.username=$("#username")[0].value,o.password=$("#password")[0].value,$.post("/api/login",o,function(e){var o="'",a=new RegExp(o,"g");e=e.replace(a,'"'),console.log(JSON.parse(e));var r=JSON.parse(e);"true"==r.status?($("#loginModal").modal("hide"),alertFun("Login Success!"),setTimeout("javascript:location.reload()",1500)):($(".login-error").css({display:"block"}),$(".login-error").text(r.message))})}}),$("#loginForm").keydown(function(e){console.log("keydown"),13==e.keyCode&&$("#login").click()}),$("#regist").on("click",function(e){if(e.preventDefault(),registCheck().form()){var o={};o.email=$("#email")[0].value,o.username=$("#registUsername")[0].value,o.password=$("#conPassword")[0].value,console.log(o),$.post("/api/register/",o,function(e){console.log(e),e.status?($("#registModal").modal("hide"),alertWithClose("Regist Success!")):($(".regist-error").css({display:"block"}),$(".regist-error").text(e.message))})}}),$("#registForm").keydown(function(e){13==e.keyCode&&$("#regist").click()}),$("#modify").on("click",function(){if(modifyPassCheck().form()){var e={};e.password=$("#oldPassword")[0].value,e.newpassword=$("#newPassword")[0].value,e.username=__username,console.log(e),$.post("/api/reset-password/",e,function(e){e.status?($("#modifyModal").modal("hide"),alertWithClose("Modify password successfully!")):($(".modify-error").css({display:"block"}),$(".modify-error").text(e.message))})}}),$("#forgetBtn").on("click",function(e){$("#forgetBtn").attr("disabled","disabled");var o={};o.email=$("#email-input")[0].value,console.log(o),$.post("/api/forget-password/",o,function(e){e.status?(alertFun("Sent success! Please check your email:)"),setTimeout(function(){$("#alertModal").modal("hide"),window.location.href="http://test.yuan25.com"},1200)):($(".forget-inf").css({display:"block"}),$(".forget-inf").text(e.message))})}),$("#book-upload-button").on("click",function(e){var o={};console.log($("#bookName")),o.bookname=$("#fbookName")[0].value,o.author=$("#fauthor").val(),o.publisher=$("#fpublisher").val(),o.publishtime=$("#fpublishTime").val(),o.isbn=$("#fISBN").val(),o.translator=$("#ftranslator").val(),o.photoURL=$("#fphotoUrl").val(),o.authorintro=$("#fauthorIntroduction").val(),o.bookintro=$("#fbookIntroduction").val(),o.classify=$("#fclassify").val(),console.log(o),$.post("/api/book-upload/",o,function(e){e.status?(alertFun(e.message),JsBarcode($("#barcode"),e.bookID,{format:"CODE128",displayValue:!0,fontSize:20}),setTimeout(function(){$("#alertModal").modal("hide")},1200)):alertWithClose(e.message)})})}),$("document").ready(function(){}),$(function(){$("#borrowForm #borrowBtn").on("click",function(e){e.preventDefault();var o={};o.username=$("#borrowUsername")[0].value,o["book-id"]=$("#isbn")[0].value,console.log(o),$.post("/api/borrow-book/",o,function(e){alertWithClose(e.message)})}),$("#borrowForm").keydown(function(e){13==e.keyCode&&$("#borrowForm #borrowBtn").click()}),$("#returnForm #isbn").on("blur",function(e){e.preventDefault(),console.log("blur");var o={};o.username=$("#returnUsername")[0].value,o["book-id"]=$("#isbn")[0].value,console.log(o),$.post("/api/single-fine/",o,function(e){if(console.log(e),-1==e&&alertWithClose("please input data"),e>=0){var o=confirm("Need to pay "+e+"$");o&&(console.log("true"),$("#returnForm #returnBtn").css({display:"inline"}))}})}),$("#returnForm #returnBtn").on("click",function(e){e.preventDefault();var o={};o.username=$("#returnUsername")[0].value,o["book-id"]=$("#isbn")[0].value,console.log(o),$.post("/api/return-book/",o,function(e){console.log(e),alertWithClose(e.message)})}),$("#returnForm").keydown(function(e){13==e.keyCode&&$("#returnForm #returnBtn").click()})}),Date.prototype.Format=function(e){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in o)new RegExp("("+a+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?o[a]:("00"+o[a]).substr((""+o[a]).length)));return e},$(function(){var e=window.location.href;-1!=e.indexOf("current-records")&&freshCurrentRecords(),-1!=e.indexOf("history-records")&&freshHistoryRecords(),-1!=e.indexOf("user?")&&freshUserInformationPage(),-1!=e.indexOf("user-fine")&&feshUserFine()});